= render :partial => 'order/menu'
= render :partial => 'items_menu'
- last_art = Artwork.find(:first, :include => { :group => :customer }, :conditions => { 'customers.id' => @order.customer.id }, :order => 'artworks.created_at DESC')
- if last_art and last_art.has_tag?('customer')
  .late CUSTOMER UPLOADED ARTWORK
= link_to("Create Product", :controller => :products, :action => :new)
|
= link_to "Sample Order", { :action => :order_duplicate, :samples => true }, { :confirm => "Create new order with samples of current items" }
|
= link_to "FREE Sample Order", { :action => :order_duplicate, :samples => true, :free => true }, { :confirm => "Create new order with FREE samples of current items" }
- if acknowledged = @order.task_completed?(AcknowledgeOrderTask)
  |
  = link_to "ReOrder", { :action => :order_duplicate }, { :confirm => "Create new reorder current items" }
  |
  = link_to "Exact ReOrder", { :action => :order_duplicate, :exact => true }, { :confirm => "Create new reorder current items" }
- if @permissions.include?('Super') && !@unlock
  .admin
    The order has been Acknowledged so customer pricing can't be changed.
    = link_to "UNLOCK", { :order_id => @order.id, :unlock => true }, { :confirm => "Unlock this page to modify items even though the order has been acknowledged!!!" }
.invoice{ :id => "order-#{@order.id}" }
  - for supplier, purchase_list in @suppliers.to_a.sort_by { |s| s.first.name }
    .supplier
      %h2= "#{link_to(supplier.name, { :controller => '/admin/suppliers', :action => :detail, :id => supplier })} (#{format_supplier_info(supplier)})"
      - for purchase in purchase_list.sort_by { |pl| (pl.id || 0) }
        .purchase
          - form_for :order, @order, { :url => { :action => (purchase.new_record? ? :purchase_create : :purchase_mark), :id => (purchase.new_record? ? supplier.id : purchase.id), :order_id => @order } } do |order|
            - if purchase.new_record?
              %h2
                Purchase Order - Create as
                - for sub in [supplier] + supplier.children
                  = submit_tag("#{sub['name']}", :onclick => "return confirm('Are you sure you want to create a PO ?')")                 
            - else
              - purchase_lock = !(params[:override] && allowed?('Super')) && purchase.locked(allowed?('Super'))
              %h2
                Purchase for
                = purchase.supplier.name
                - if purchase.purchase_order.quickbooks_ref
                  (PO:
                  = purchase.purchase_order.quickbooks_ref
                  - if purchase.bill
                    Bill:
                    - if ReconciledItemTask.allowed?(@permissions) and !purchase.reconciled
                      = text_field_tag "Bill-#{purchase.bill.id}-quickbooks_ref", purchase.bill.quickbooks_ref, 'size' => 8, :readonly => purchase_lock
                    - else
                      = purchase.bill.quickbooks_ref                      
                  )
                  - if url = purchase.supplier_status_url
                    = link_to "Supplier Status", url
                - if purchase.supplier != supplier
                  = "(#{format_supplier_info(purchase.supplier)})"
                %div
                  = link_to image_tag('html.png'), :action => :po, :id => purchase
                  = link_to image_tag('pdf.png'), :action => :po, :id => purchase, :format => 'pdf'
              - if purchase.items.first.task_ready?(OrderSentItemTask)
                = submit_tag "Send by #{purchase.fax? ? 'FAX' : 'eMail'} #{OrderSentItemTask.status_name}"
                = submit_tag "Mark #{OrderSentItemTask.status_name} (Without email)"
              - elsif purchase.items.first.task_ready?(ConfirmItemTask)
                = submit_tag ConfirmItemTask.status_name
              - elsif purchase.items.first.task_ready?(EstimatedItemTask)
                = hidden_field_tag(:function, 'estimated')
                = EstimatedItemTask.status_name
                = calendar_input('data[ship_date]', '', { :class => 'ignore' }, {}, "_#{purchase.id}")
                Days Shipping:
                = text_field(:data, :ship_days, { :size => 3, :value => purchase.items.first.shipping && purchase.items.first.shipping.days, :class => 'ignore' })
                = check_box :data, :ship_saturday
                Saturday Delivery
                = submit_tag 'Completed'
                = submit_tag 'Completed (Without Email)'
              - elsif purchase.items.first.task_ready?(ShipItemTask)
                = hidden_field_tag(:function, 'ship')
                = select(:data, :carrier, ShippingRate.carriers)
                = text_field(:data, :tracking, { :size => 20, :class => 'ignore' })
                = submit_tag 'Completed'
                = submit_tag 'Completed (Without Email)'
              - elsif purchase.items.first.task_ready?(ReconciledItemTask)
                - if ReconciledItemTask.allowed?(@permissions)
                  = submit_tag ReconciledItemTask.status_name
                - else
                  = ReconciledItemTask.waiting_name
              - elsif purchase.reconciled
                %strong= ReconciledItemTask.completed_name
            - for item in purchase.items
              = render :partial => 'order_item', :locals => { :item => item, :purchase_lock => purchase_lock }
            - unless purchase.new_record?
              .block.notes
                %strong Notes for Supplier:
                = text_field_tag "Purchase-#{purchase.id}-comment", purchase.comment, :size => 80, :readonly => purchase_lock
              = render :partial => 'order', :locals => { :order => purchase, :purchase_lock => purchase_lock }
  = render :partial => 'order', :locals => { :order => @order, :purchase_lock => false }

- unless @tasks.empty? and @revokable.empty?
  %hr
  = render :partial => 'order/pending_tasks'

